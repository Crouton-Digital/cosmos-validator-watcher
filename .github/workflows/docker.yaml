name: Build container

on:
  workflow_dispatch:
  push:
    tags: [ 'v*.*.*' ]


env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build_container:
    name: Build and Push image to GitHub Containers
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      #id-token: write
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}
      - name: Set correct environment
        run: |
          echo "Git from GITHUB_REF_NAME: $GITHUB_SHA"
          echo "Git from container tag: ${{ github.ref_name }}"
      - name: Set Datetime as Environment Variable
        run: echo "DATETIME=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
      - name: Set $GITHUB_ENV as Environment Variable
        run: echo "GIT_SHA=$GITHUB_SHA" >> $GITHUB_ENV
      - name: Build and push image
        uses: docker/build-push-action@v5.0.0
        with:
          context: "{{defaultContext}}"
          tags: "ghcr.io/crouton-digital/story-validator-exporter:${{ github.ref_name }}"
          push: true
